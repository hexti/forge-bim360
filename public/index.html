<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <title>Concremat Engenharia .::. Plenus</title>

    <link rel="shortcut icon" href="/img/favicon.png">

    <!-- Bootstrap core CSS -->
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/bootstrap-nav-wizard.css" rel="stylesheet">

    <!-- Custom Css -->
    <link rel="stylesheet" href="./lib/adminbsb-materialdesign/css/style.css">

    <link type="text/css" href="./css/style.css">

    <link href="/css/main.css" rel="stylesheet" />

    <link rel="stylesheet" href="./lib/adminbsb-materialdesign/css/themes/all-themes.css">

    <link rel="stylesheet" href="./js/jquery-ui-1.11.4/jquery-ui.css">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/jquery-ui-1.11.4/jquery-ui.js"></script>

    <!-- Toastr notifications -->
    <link href="./js/bower_components/toastr/toastr.css" rel="stylesheet"/>

    <!-- Select2 -->
    <link href="./js/bower_components/select2/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="/js/bower_components/select2/dist/js/select2.min.js"></script>

    <!-- Folhas de Estilo para Novo Layout -->
    <!-- Google Fonts -->
    <link href="//fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" type="text/css">

    <!-- Bootstrap Select Css -->
    <link rel="stylesheet" href="./lib/adminbsb-materialdesign/plugins/bootstrap-select/css/bootstrap-select.css">

    <!-- Waves Effect Css -->
    <link rel="stylesheet" href="./lib/adminbsb-materialdesign/plugins/node-waves/waves.css">

    <link rel="stylesheet" href="./lib/adminbsb-materialdesign/plugins/sweetalert/sweetalert.css">

    <!-- Animation Css -->
    <link rel="stylesheet" href="./lib/adminbsb-materialdesign/plugins/animate-css/animate.min.css">

    <!-- Multi Select Css -->
    <link rel="stylesheet" href="./lib/adminbsb-materialdesign/plugins/multi-select/css/multi-select.css">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/v/bs/pdfmake-0.1.18/dt-1.10.13/af-2.1.3/b-1.2.4/b-colvis-1.2.4/b-flash-1.2.4/b-html5-1.2.4/b-print-1.2.4/cr-1.3.2/fc-3.2.2/fh-3.1.2/kt-2.2.0/r-2.1.0/rr-1.2.0/sc-1.4.2/se-1.2.0/datatables.min.css"/>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.10/themes/default/style.min.css" integrity="sha512-P8BwDSUInKMA7I116Z1RFg/Dfk85uFdliEUYO7vQlwtxLVMNvZimfMAQsaf++9EhlAGOVX6yhDQAIY3/70jDUg==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" type="text/css">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="./css/toast.css">

    <style>
        .sidebar .user-info {
            background: #2196F3
        }

        .spinner-layer {
            border-color: #2196F3
        }
    </style>
</head>

<body class="theme-blue">
    <div class="page-loader-wrapper">
        <div class="loader">
            <div class="preloader">
                <div class="spinner-layer">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
            <p>Aguarde...</p>
        </div>
    </div>

    <nav class="navbar">
        <div class="container-fluid">
            <div class="navbar-header">
                <a href="#" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false"></a>
                <a href="#" class="bars">&nbsp;</a>
                <a class="navbar-brand logo" href="./index.html" style="padding: 0px 15px;">
                    <img width="190px" src="./img/cmat.png">
                </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                  <li>
                    <a href="#" onclick="closePanel()" class="btn-search-issues" data-toggle="modal" data-target="#filterIssues" role="button" style="display: none;">
                      <i class="material-icons">filter_alt</i>
                    </a>
                  </li>
                  <li>
                    <a href="#" onclick="exportXLS(this)" class="btn-search-issues" data-toggle="modal" role="button" style="display: none;">
                      <i class="material-icons">description</i>
                      <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                    </a>
                  </li>
                  <li>
                    <a name="screenshot" href="#" class="btn-search-issues" data-toggle="modal" role="button" style="display: none;">
                      <i class="material-icons">camera_alt</i>
                      <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                    </a>
                  </li>
                  <li>
                    <a name="pdf" href="#" class="btn-search-issues" data-toggle="modal" role="button" style="display: none;">
                      <i class="material-icons">print</i>
                      <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                    </a>
                  </li>
                  <!-- <li class="dropdown">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button">
                          <i class="material-icons">notifications</i>
                          <span class="label-count">1</span>
                      </a>
                      <ul class="dropdown-menu">
                          <li class="header">NOTIFICAÇÃO</li>
                          <li class="body">
                          </li>
                          <li class="footer">
                              <a href="#">Visualiazar Todas as Notificações</a>
                          </li>
                      </ul>
                  </li> -->
                </ul>
            </div>
        </div>
    </nav>

    <section>
        <!-- Left Sidebar -->
        <aside id="leftsidebar" class="sidebar">
            <!-- User Info -->
            <div class="user-info">
                <div class="image">
                    <!-- <img src="" width="48" height="48" alt="User" /> -->
                </div>
                <div class="info-container">
                    <div class="name" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Anderson Freitas
                    </div>
                    <div class="email">
                        anderson.freitas@concremat.com.br
                    </div>

                    <form action="#" method="post" name="logout">
                        <input type="hidden" name="intent" value="#">
                        <div class="btn-group user-helper-dropdown">
                            <i class="material-icons" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">keyboard_arrow_down</i>
                            <ul class="dropdown-menu pull-right">
                                <li>
                                    <a href="#"><i class="material-icons">persona</i>Perfil</a>
                                </li>
                                <li>
                                    <a href="#"><i class="material-icons">vpn_key</i>Trocar Senha</a>
                                </li>
                                <li role="seperator" class="divider"></li>
                                <li>
                                    <a href="#"><i class="material-icons">input</i>Sair</a>
                                </li>
                            </ul>
                        </div>
                    </form>
                </div>
            </div>
            <!-- #User Info -->
            <!-- Menu -->
            <div class="menu">
                <ul class="list">
                    <li class="header">Menu Principal</li>
                    <li>
                        <a href="/">
                            <i class="material-icons">home</i>
                            <span>Início</span>
                        </a>
                    </li>

                    <li>
                      <a href="#" data-toggle="modal" data-target="#listHub">
                        <i class="material-icons">folder</i>
                          <span>Modelos - BIM360</span>
                      </a>
                    </li>
                </ul>
            </div>
            <!-- #Menu -->

            <!-- Footer -->
            <!-- <div class="legal">
                <div class="copyright">
                    <p>
                        <a href="#">Problemas ao utilizar o sistema?</a>
                    </p>
                </div>
                <div class="copyright">
                    &copy; 2017 - <?=date('Y')?>
                    <a target="_blank" href="//www.concremat.com.br">Concremat Engenharia.<br>
                        <img width="30%" src="./img/concremat_port340.png"></a>
                </div>
            </div> -->
            <!-- #Footer -->
        </aside>

        <!-- #END# Left Sidebar -->
    </section>

    <section class="content" style="margin-top: 40px;">
      <div class="container-fluid fill">
        <div class="card">
          <div class="body">
            <div class="row clearfix fill">
              <div class="col-sm-12 col-md-12 col-lg-12 fill">
                  <div id="forgeViewer"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="modal fade" id="listHub">
      <div class="modal-dialog wide">
        <div class="modal-content">
          <div class="modal-body" style="height: 100%;">
            <div id="userHubs">
              <div style="padding-top: 100px; text-align: center;">
                <button class="btn btn-lg btn-default" id="autodeskSigninButton">
                  <img src="//github.com/Autodesk-Forge/learn.forge.viewhubmodels/raw/master/img/autodesk_text.png" height="20"> Sign in
                </button>
                <br/>
                <br/>
                <br/> You may also need to provision your<br/> BIM 360 Docs account for this app.<br/>
                <a href="//forge.autodesk.com/blog/bim-360-docs-provisioning-forge-apps">Learn more</a>.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="pdfModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="btn btn-primary">Imprimir</button>
                    <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body"></div>
                </div>
        </div>
    </div>

    <div class="modal fade" id="filterIssues" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title text-bold" id="exampleModalLabel">Filtro de Anomalias</h3>
          </div>
          <div class="modal-body">
            <label>Issue</label>
            <select class="form-control" id="issueId">
              <option value="">Selecione ...</option>
            </select>
            <label>Causa Raiz</label>
            <select class="form-control" id="causaRaiz">
              <option value="">Selecione ...</option>
            </select>
            <label>Nivel de Alerta</label>
            <select class="form-control" id="nivelAlerta">
              <option value="" selected>Selecione ...</option>
            </select>
            <label>Elemento (Detalhe da Localização)</label>
            <select class="form-control" id="location">
              <option value="">Selecione ...</option>
            </select>
            <label>Face</label>
            <select class="form-control" id="face">
              <option value="" selected>Selecione ...</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal" onClick="showIssues()">Filtrar</button>
            <button type="button" class="btn btn-warning" data-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
          <div class="modal-header">
              <h3 class="modal-title text-bold" id="exampleModalLabel">Anexos da Anomalia</h3>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body" id="img">
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
          </div>
          </div>
      </div>
    </div>

    <button type="button" id="btn-anexo" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" style="display: none;">
    Launch demo modal
    </button>

  <!-- Bootstrap Core Js -->
  <script type="text/javascript" src="./lib/adminbsb-materialdesign/plugins/bootstrap/js/bootstrap.min.js"></script>

  <!-- Slimscroll Plugin Js -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/jQuery-slimScroll/1.3.8/jquery.slimscroll.min.js" integrity="sha512-cJMgI2OtiquRH4L9u+WQW+mz828vmdp9ljOcm/vKTQ7+ydQUktrPVewlykMgozPP+NUBbHdeifE6iJ6UVjNw5Q==" crossorigin="anonymous"></script>

  <!-- Waves Effect Plugin Js -->
  <script type="text/javascript" src="./lib/adminbsb-materialdesign/plugins/node-waves/waves.js"></script>


  <!-- Jquery CountTo Plugin Js -->

  <!-- DateTimePicker -->

  <script src="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/js/all.min.js" integrity="sha512-Sr1M6mlMOXTKahO1wcUzFu/kAb3iZVaQWGvxOEePRm7c2NjGRZ7ckRT6218PaSXlz8eEoFpKkDVvl2rTqKrQLA==" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.7/jstree.min.js" integrity="sha512-z8+IQvZEPLZTS3Dj7gklMVJfJMNbQjIQwmKMwAuX+P9KkzEmDIiXybdXsbWuoMlQ942SfyNafeu6JdOGwzCx0Q==" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/axios/0.21.0/axios.min.js" integrity="sha512-DZqqY3PiOvTP9HkjIWgjO6ouCbq+dxqWoJZ/Q+zPYNHmlnI2dQnbJ5bxAHpAMw+LXRm4D72EIRXzvcHQtE8/VQ==" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment-with-locales.min.js" integrity="sha512-+4wyLnVjbJnGld2sKt9RE0zwcDRmr2KimlbeYRRMZFqfKYV2o69ncGWG12VGMySqnPKZXpT8qq+p8OZJIZsTkQ==" crossorigin="anonymous"></script>

  <script src="//developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <script src="/js/ForgeTree.js"></script>
  <script src="/js/ForgeViewer.js"></script>
  <script src="/js/BIM360IssueExtension.js"></script>
  <script src="/js/IconMarkupExtension.js"></script>
  <script src="/js/getIssues.js"></script>

  <script>
    $('select').select2({width: '100%', dropdownParent: $('#filterIssues')})
      $(function () {
          const url = location.origin + location.pathname

          $(`ul.list li a[href='${url}']`).addClass('toggled')
              .parents('li')
              .addClass('active')

          $('form[name=logout]').find('a').last().click(function () {
              $('form[name=logout]').submit()
          })
      })
  </script>

  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
      moment.locale('pt-BR')
      document.querySelector('a[name=pdf]')
        .addEventListener('click', exportPDF)
      document.querySelector('a[name=screenshot]')
        .addEventListener('click', screenshot)
    })
  </script>

  <script type="text/javascript">
    var localizacaoEsquematica;

    function screenshot() {
      const $camera = $(this).find('.material-icons').first()
      const $spin = $(this).find('.fa-spinner').first()

      this.style.pointerEvents = 'none'

      $camera.hide()
      $spin.show()

      // Get the full image
      viewer.impl.getScreenShotProgressive(viewer.container.clientWidth, viewer.container.clientHeight, (blobURL) => {
        localizacaoEsquematica = blobURL
        $.fn.toast(`<img src="${blobURL}" width="100%">`)
        $spin.hide()
        $camera.show()

        this.style.pointerEvents = null
      });
    }

    function closePanel(){
      $('.docking-panel-close').click();
    }

    function showIssues(){
      localStorage.removeItem('nivelAlerta');
      localStorage.removeItem('causaRaiz');
      localStorage.removeItem('issueId');
      localStorage.removeItem('localizacao');
      localStorage.removeItem('face');

      let nivelAlerta = $('#nivelAlerta').val()
      let causaRaiz = $('#causaRaiz').val()
      let issueId = $('#issueId').val()
      let localizacao = $('#location').val()
      let face = $('#face').val()

      if(!nivelAlerta && !causaRaiz && !issueId && !localStorage && !face){
        alert('Selecione uma opção!')
      }else{
        localStorage.setItem('nivelAlerta', nivelAlerta)
        localStorage.setItem('causaRaiz', causaRaiz)
        localStorage.setItem('issueId', issueId)
        localStorage.setItem('localizacao', localizacao)
        localStorage.setItem('face', face)
        $('.loadQualityIssues').click()
      }
    }

    function exportXLS(_this){
      const $pdf = $(_this).find('.material-icons').first()
      const $spin = $(_this).find('.fa-spinner').first()

      let selected = getSelectedNode()

      let url = selected.project.split("/");
      let count = url.length - 1
      let containerId = url[count].substring(2);
      let urn = selected.urn;

      $pdf.hide()
      $spin.show()

      axios.get(`/export/xls?token=${localStorage.getItem('token')}&container=${containerId}&urn=${urn}`, {responseType: 'blob'})
      .then((res) => {
        const url = window.URL.createObjectURL(new Blob([res.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', 'report.xlsx');
        document.body.appendChild(link);
        link.click();
        link.remove();
      })
      .catch((error) => {
        console.error(error)
      })
      .finally(() => {
        $spin.hide()
        $pdf.show()
      })
    }

    function exportPDF () {
      const $pdf = $(this).find('.material-icons').first()
      const $spin = $(this).find('.fa-spinner').first()

      const selected = getSelectedNode()
      const url = selected.project.split('/');
      const c = url.length - 1
      const containerId = url[c].substring(2);
      const urn = selected.urn;
      const token = localStorage.getItem('token')

      const relatorio = new Worker('./js/RelatorioPDF.js')

      this.style.pointerEvents = 'none'

      $pdf.hide()
      $spin.show()

      relatorio.addEventListener('message', (ev) => {
        const page = 'relatorio-' + (new Date).getTime().toString()
        const blob = new Blob([
          `<!DOCTYPE html><html><head><meta charset="utf-8" /><title>${page}</title></head><body>`, ev.data[0], '</body></html>'
        ], {type: 'text/html'})
        const objUrl = URL.createObjectURL(blob)
        const frame = document.createElement('iframe')
        frame.setAttribute('src', objUrl)
        frame.style.width = '100%'
        frame.style.height = '75vh'

        const $modal = $('#pdfModal')

        $modal.find('.modal-body').html(frame)
        $modal.find('.modal-header')
          .children()
          .first()
          .off()
          .click(() => {
            frame.contentWindow.print()
          })

        $modal.modal()
        $spin.hide()
        $pdf.show()

        this.style.pointerEvents = 'none'
      })

      relatorio.addEventListener('error', (ev) => {
        console.error(ev)
        $spin.hide()
        $pdf.show()

        this.style.pointerEvents = 'none'
        alert('Ocorreu um erro ao tentar gerar um relatório')
      })

      relatorio.postMessage({ token, containerId, urn, localizacaoEsquematica })
    }

    localStorage.removeItem('nivelAlerta');
    localStorage.removeItem('causaRaiz');
    localStorage.removeItem('issueId');
    localStorage.removeItem('localizacao');
    localStorage.removeItem('face');
  </script>

  <script src="./lib/adminbsb-materialdesign/js/admin.js"></script>
  <script src="./js/toast.js"></script>

  </body>
</html>
